---
otel: &channel-otel stable
otel-namespace: &otel-namespace openshift-opentelemetry-operator

######################################
# SUBCHART: helper-operator
# Operators that shall be installed.
######################################
helper-operator:
  operators:
    opentelemetry-product:
      enabled: true
      namespace:
        name: *otel-namespace
        create: true
      subscription:
        channel: *channel-otel
        approval: Automatic
        operatorName: opentelemetry-product
        source: redhat-operators
        sourceNamespace: openshift-marketplace
      operatorgroup:
        create: true
        notownnamespace: true

########################################
# SUBCHART: helper-status-checker
# Verify the status of a given operator.
########################################
helper-status-checker:
  enabled: true

  approver: false

  checks:
    - operatorName: opentelemetry-operator
      subscriptionName: opentelemetry-operator
      namespace:
        name: *otel-namespace
      syncwave: 1

      serviceAccount:
        name: "status-checker-otel"

rh-build-of-opentelemetry:
  #########################################################################################
  # namespace ... disabled here, since we deployed it via Tempo already
  #########################################################################################
  namespace:
    name: tempostack
    create: false

  #########################################################################################
  # OPENTELEMETRY COLLECTOR - Production Configuration
  #########################################################################################
  collector:
    enabled: true
    name: otel
    mode: deployment
    replicas: 1

    serviceAccount: otel-collector
    managementState: managed

    resources: {}

    tolerations: []

    config:
      connectors:
        routing/traces:
          default_pipelines:
            - traces/Default
          error_mode: ignore
          table:
            - pipelines:
                - traces/tenantA
              statement: 'route() where attributes["k8s.namespace.name"] == "team-a"'
            - pipelines:
                - traces/tenantB
              statement: 'route() where attributes["k8s.namespace.name"] == "team-b"'

      receivers:
        # OTLP receivers for traces, metrics, and logs
        otlp:
          protocols:
            grpc:
              endpoint: 0.0.0.0:4317
            http:
              endpoint: 0.0.0.0:4318

        # Jaeger receiver (if migrating from Jaeger)
        jaeger:
          protocols:
            grpc:
              endpoint: 0.0.0.0:14250
            thrift_http:
              endpoint: 0.0.0.0:14268

      processors:
        batch:
          send_batch_size: 10000
          timeout: 10s
        k8sattributes: {}
        memory_limiter:
          check_interval: 1s
          limit_percentage: 75
          spike_limit_percentage: 15
        resourcedetection:
          detectors:
            - openshift
          timeout: 2s

      exporters:
        otlp/tenantX:
          auth:
            authenticator: bearertokenauth
          endpoint: 'tempo-simplest-gateway:8090'
          headers:
            X-Scope-OrgID: tenantX
          tls:
            ca_file: /var/run/secrets/kubernetes.io/serviceaccount/service-ca.crt
            insecure: true
            insecure_skip_verify: true
            server_name_override: tempo-simplest-gateway.tempostack.svc.cluster.local
        otlp:
        prometheus:
          add_metric_suffixes: false
          endpoint: '0.0.0.0:8889'
          resource_to_telemetry_conversion:
            enabled: true
        otlp/tenantA:
          auth:
            authenticator: bearertokenauth
          endpoint: 'tempo-simplest-gateway:8090'
          headers:
            X-Scope-OrgID: tenantA
          tls:
            ca_file: /var/run/secrets/kubernetes.io/serviceaccount/service-ca.crt
            insecure: true
            insecure_skip_verify: true
            server_name_override: tempo-simplest-gateway.tempostack.svc.cluster.local
        otlp/tenantB:
          auth:
            authenticator: bearertokenauth
          endpoint: 'tempo-simplest-gateway:8090'
          headers:
            X-Scope-OrgID: tenantB
          tls:
            ca_file: /var/run/secrets/kubernetes.io/serviceaccount/service-ca.crt
            insecure: true
            insecure_skip_verify: true
            server_name_override: tempo-simplest-gateway.tempostack.svc.cluster.local
        otlp/Default:
          auth:
            authenticator: bearertokenauth
          endpoint: 'tempo-simplest-gateway:8090'
          headers:
            X-Scope-OrgID: dev
          tls:
            ca_file: /var/run/secrets/kubernetes.io/serviceaccount/service-ca.crt
            insecure: true
            insecure_skip_verify: true
            server_name_override: tempo-simplest-gateway.tempostack.svc.cluster.local

      extensions:
        bearertokenauth:
          filename: /var/run/secrets/kubernetes.io/serviceaccount/token

      service:
        extensions:
          - bearertokenauth
        pipelines:
          traces/Default:
            exporters:
              - otlp/Default
            receivers:
              - routing/traces
          traces/in:
            exporters:
              - routing/traces
            processors:
              - resourcedetection
              - k8sattributes
              - memory_limiter
              - batch
            receivers:
              - otlp
          traces/tenantA:
            exporters:
              - otlp/tenantA
            receivers:
              - routing/traces
          traces/tenantB:
            exporters:
              - otlp/tenantB
            receivers:
              - routing/traces
