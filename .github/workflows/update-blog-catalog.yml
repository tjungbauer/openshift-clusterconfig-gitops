name: Update Blog GitOps Catalog

on:
  push:
    branches:
      - main
    paths:
      - 'clusters/**'
  workflow_dispatch:  # Allow manual trigger

env:
  BLOG_REPO: stderrat/blog-src
  BLOG_BRANCH: master
  DATA_FILE_PATH: data/gitops_applications.json

jobs:
  generate-catalog:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.compare.outputs.has_changes }}
      app_count: ${{ steps.generate.outputs.app_count }}
    
    steps:
      - name: Checkout GitOps Repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0
      
      - name: Install jq
        run: sudo apt-get install -y jq
      
      - name: Generate GitOps Catalog JSON
        id: generate
        run: |
          chmod +x ./scripts/generate-catalog-json.sh
          ./scripts/generate-catalog-json.sh > gitops_applications.json
          
          # Validate JSON
          if jq empty gitops_applications.json 2>/dev/null; then
            echo "âœ… Generated valid JSON"
            echo "app_count=$(jq '.applications | length' gitops_applications.json)" >> $GITHUB_OUTPUT
          else
            echo "âŒ Generated invalid JSON"
            exit 1
          fi
      
      - name: Fetch existing catalog from blog repo
        id: fetch_existing
        run: |
          # Try to fetch the existing JSON from the blog repo
          EXISTING_URL="https://raw.githubusercontent.com/${{ env.BLOG_REPO }}/${{ env.BLOG_BRANCH }}/${{ env.DATA_FILE_PATH }}"
          echo "Fetching existing catalog from: $EXISTING_URL"
          
          if curl -sf "$EXISTING_URL" -o existing_catalog.json 2>/dev/null; then
            echo "âœ… Fetched existing catalog"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ No existing catalog found (first run or file doesn't exist)"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Compare catalogs
        id: compare
        run: |
          if [[ "${{ steps.fetch_existing.outputs.exists }}" == "false" ]]; then
            echo "ðŸ“¦ No existing catalog - changes detected (first run)"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            # Normalize JSON (sort keys, remove whitespace differences) before comparing
            jq -S '.' gitops_applications.json > new_normalized.json
            jq -S '.' existing_catalog.json > existing_normalized.json
            
            if diff -q new_normalized.json existing_normalized.json > /dev/null 2>&1; then
              echo "âœ… No changes detected - catalog is up to date"
              echo "has_changes=false" >> $GITHUB_OUTPUT
            else
              echo "ðŸ“ Changes detected in catalog"
              echo "has_changes=true" >> $GITHUB_OUTPUT
              
              # Show what changed (for debugging)
              echo "### Changes:" >> $GITHUB_STEP_SUMMARY
              diff new_normalized.json existing_normalized.json | head -50 >> $GITHUB_STEP_SUMMARY || true
            fi
          fi
      
      - name: Display Summary
        run: |
          echo "### GitOps Catalog Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Applications:** ${{ steps.generate.outputs.app_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Last Updated:** $(date +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes Detected:** ${{ steps.compare.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Categories" >> $GITHUB_STEP_SUMMARY
          jq -r '.categories | to_entries[] | "- \(.value.name)"' gitops_applications.json >> $GITHUB_STEP_SUMMARY
      
      - name: Upload Artifact
        if: steps.compare.outputs.has_changes == 'true'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: gitops-catalog
          path: gitops_applications.json
          retention-days: 30

  update-blog:
    needs: generate-catalog
    runs-on: ubuntu-latest
    # Only run if changes were detected
    if: needs.generate-catalog.outputs.has_changes == 'true'
    
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: gitops-catalog
      
      - name: Checkout Blog Repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          repository: ${{ env.BLOG_REPO }}
          token: ${{ secrets.BLOG_PAT }}
          path: blog
          ref: ${{ env.BLOG_BRANCH }}
      
      - name: Update Catalog Data
        run: |
          mkdir -p blog/$(dirname ${{ env.DATA_FILE_PATH }})
          cp gitops_applications.json blog/${{ env.DATA_FILE_PATH }}
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8
        with:
          path: blog
          token: ${{ secrets.BLOG_PAT }}
          commit-message: "chore: Update GitOps catalog from openshift-clusterconfig-gitops"
          title: "ðŸ“¦ Update GitOps Application Catalog"
          body: |
            This PR updates the GitOps Application Catalog data.
            
            **Triggered by:** Push to `${{ github.repository }}@${{ github.sha }}`
            
            **Changes:**
            - Updated application metadata from Chart.yaml and config.json files
            - Regenerated catalog with latest application data
            
            ---
            *This PR was automatically created by the [Update Blog GitOps Catalog](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) workflow.*
          branch: update-gitops-catalog
          delete-branch: true
          labels: |
            automated
            documentation

  # Alternative: Direct commit (faster, but no review)
  # To use this instead of update-blog, change the if conditions
  direct-update:
    needs: generate-catalog
    runs-on: ubuntu-latest
    # Set to: needs.generate-catalog.outputs.has_changes == 'true'
    # And set update-blog to false to switch modes
    if: false
    
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: gitops-catalog
      
      - name: Checkout Blog Repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          repository: ${{ env.BLOG_REPO }}
          token: ${{ secrets.BLOG_PAT }}
          path: blog
          ref: ${{ env.BLOG_BRANCH }}
      
      - name: Update and Push
        working-directory: blog
        run: |
          mkdir -p $(dirname ${{ env.DATA_FILE_PATH }})
          cp ../gitops_applications.json ${{ env.DATA_FILE_PATH }}
          
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add ${{ env.DATA_FILE_PATH }}
          git commit -m "chore: Auto-update GitOps catalog [skip ci]"
          git push
          echo "âœ… Successfully updated blog catalog"

